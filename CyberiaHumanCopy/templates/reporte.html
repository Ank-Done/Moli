{% extends "base.html" %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>{{ title }}</h2>
        <div class="export-buttons" id="exportButtons">
            <!-- Los botones de exportación se generarán automáticamente por DataTables -->
        </div>
    </div>
    
    <div class="date-filter-container">
        <h5><i class="fas fa-calendar-alt"></i> Filtro de Fechas</h5>
        <div class="row align-items-end">
            <div class="col-md-6">
                <label for="dateRange" class="form-label">Rango de fechas:</label>
                <div class="date-input-group">
                    <input type="text" id="dateRange" class="form-control" value="2023-01-01 - 2025-12-31">
                </div>
                <small class="text-light">Por defecto muestra datos de 2023 a 2025</small>
            </div>
            <div class="col-md-3">
                <button type="button" id="resetDateFilter" class="btn btn-outline-light">
                    <i class="fas fa-undo"></i> Resetear
                </button>
            </div>
            <div class="col-md-3">
                <label for="quickSearch" class="form-label">Búsqueda rápida:</label>
                <input type="text" id="quickSearch" class="form-control" placeholder="Buscar...">
            </div>
        </div>
    </div>
    
    <div class="filter-bar">
        <div class="row">
            <div class="col-md-4">
                <label for="yearQuickFilter" class="form-label">Filtro rápido por año:</label>
                <select id="yearQuickFilter" class="form-select">
                    <option value="">Usar filtro de fecha personalizado</option>
                    <option value="2025">Solo 2025</option>
                    <option value="2024">Solo 2024</option>
                    <option value="2023">Solo 2023</option>
                    <option value="2024-2025">2024-2025</option>
                    <option value="2023-2024">2023-2024</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="recordsPerPage" class="form-label">Registros por página:</label>
                <select id="recordsPerPage" class="form-select">
                    <option value="25">25 registros</option>
                    <option value="50" selected>50 registros</option>
                    <option value="100">100 registros</option>
                    <option value="-1">Mostrar todos</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Total de registros:</label>
                <div class="alert alert-info mb-0" id="recordCount">
                    <i class="fas fa-info-circle"></i> <span id="totalRecords">Calculando...</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="table-responsive">
        {{ data|safe }}
    </div>
    
    <script>
        $(document).ready(function() {
            // Búsqueda personalizada
            $('#quickSearch').on('keyup', function() {
                if (globalTable) {
                    globalTable.search(this.value).draw();
                }
            });
            
            // Filtro rápido por año
            $('#yearQuickFilter').on('change', function() {
                const selectedRange = this.value;
                if (selectedRange) {
                    let startDate, endDate;
                    
                    switch(selectedRange) {
                        case '2025':
                            startDate = '2025-01-01';
                            endDate = '2025-12-31';
                            break;
                        case '2024':
                            startDate = '2024-01-01';
                            endDate = '2024-12-31';
                            break;
                        case '2023':
                            startDate = '2023-01-01';
                            endDate = '2023-12-31';
                            break;
                        case '2024-2025':
                            startDate = '2024-01-01';
                            endDate = '2025-12-31';
                            break;
                        case '2023-2024':
                            startDate = '2023-01-01';
                            endDate = '2024-12-31';
                            break;
                        default:
                            return;
                    }
                    
                    // Actualizar el daterangepicker
                    $('#dateRange').data('daterangepicker').setStartDate(moment(startDate));
                    $('#dateRange').data('daterangepicker').setEndDate(moment(endDate));
                    
                    // Simular el evento apply del daterangepicker
                    $('#dateRange').trigger('apply.daterangepicker', {
                        startDate: moment(startDate),
                        endDate: moment(endDate)
                    });
                }
            });
            
            // Cambiar registros por página
            $('#recordsPerPage').on('change', function() {
                if (globalTable) {
                    globalTable.page.len(parseInt(this.value)).draw();
                    updateRecordCount();
                }
            });
            
            // Función para actualizar contador de registros
            function updateRecordCount() {
                setTimeout(function() {
                    if (globalTable) {
                        const info = globalTable.page.info();
                        $('#totalRecords').text(`${info.recordsDisplay} registros mostrados de ${info.recordsTotal} total`);
                    }
                }, 100);
            }
            
            // Actualizar contador cuando se inicializa la tabla
            setTimeout(function() {
                updateRecordCount();
                
                // Actualizar contador cuando se filtra
                if (globalTable) {
                    globalTable.on('draw', function() {
                        updateRecordCount();
                    });
                }
            }, 1000);
        });
    </script>
{% endblock %}